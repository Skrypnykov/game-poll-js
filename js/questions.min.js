import{URL,questionMax,wrongColor,trueColor}from"./constants.js";import{apiGet}from"./getData.min.js";import create from"./create.min.js";import{verifyAuth}from"./users.min.js";import setData from"./setData.min.js";import{start,stop}from"./timer.min.js";const questionsQuantity=document.getElementById("questionsQuantity"),questionsScore=document.getElementById("questionsScore"),questionBlock=document.getElementById("questionBlock"),answersBlock=document.getElementById("answersBlock"),headerBlock=document.querySelector(".header-wrapper"),quitBtn=document.getElementById("quit"),questionText=document.getElementById("question"),modalClose=document.getElementById("modalClose"),modalOk=document.getElementById("modalOk"),modalTipText=document.getElementById("modalTipText"),modalText=document.getElementById("modalText"),goals=document.querySelector(".goals"),bg=document.querySelector(".page"),timer=document.getElementById("timer"),emptyAnswerText="\u041D\u0435\u043E\u0431\u0445\u0456\u0434\u043D\u043E \u0434\u0430\u0442\u0438 \u0432\u0456\u0434\u043F\u043E\u0432\u0456\u0434\u044C :-)",fullUrl=URL+"questions";let trueAnswer,questionNum=1,catchAnswer=!1,qtyWrong=0,qtyCorrect=0,scores=0,question={},trueAnswerBlock={},questionsArr=[],userData=JSON.parse(localStorage.getItem("userData"));async function handler(){apiGet(fullUrl).then(a=>{const b=a;b&&setQuestion(b),setUserInfo()}).catch(a=>{console.log(a.message)})}const quit=()=>{$("#modalQuit").modal("show")};quitBtn.addEventListener("click",quit);const seeResult=()=>{const a=localStorage.getItem("token"),b=localStorage.getItem("userId");if(userData=JSON.parse(localStorage.getItem("userData")),a&&b&&userData){setData(URL+"users/"+b,a,{score:scores}).then(a=>{a.status&&console.log("Ok")}).catch(a=>{console.log(a)})}localStorage.setItem("result",scores),setTimeout(()=>location.href="./result.html",1e3)},nextQuestion=()=>{questionNum>=questionMax?seeResult():(++questionNum,questionText.innerText="",answersBlock.innerText="",timer.value=90,start(timer.value),setQuestion())},showModal=(a,b)=>{a&&(modalTipText.innerText=a),$("#modalTip").modal("show"),b&&setTimeout(()=>$("#modalTip").modal("hide"),b),modalClose.addEventListener("click",()=>nextQuestion(),{once:!0}),modalOk.addEventListener("click",()=>nextQuestion(),{once:!0})},showModalEmptyAnswer=a=>{modalText.innerText=a?a:emptyAnswerText,$("#modalRange").modal("show"),setTimeout(()=>$("#modalRange").modal("hide"),2e3)},answerIsTrue=()=>{stop(),qtyCorrect++,scores+=5,qtyWrong=0,question.tip?showModal(question.tip):setTimeout(()=>nextQuestion(),2500)};export const answerIsWrong=()=>{stop(),qtyWrong++,qtyCorrect=0,1<qtyWrong&&scores--,question.tip?showModal(question.tip):setTimeout(()=>nextQuestion(),2e3)};const verifyAnswer=a=>{if(!catchAnswer&&(catchAnswer=!0,!Array.isArray(a))){const b=a.innerText;b===trueAnswer?(answerIsTrue(a),a.style.backgroundColor=trueColor):(answerIsWrong(a),a.style.backgroundColor=wrongColor,trueAnswerBlock.style.backgroundColor=trueColor)}},questionsQuantityUpdate=()=>{questionsQuantity.innerText=questionNum},questionsScoreUpdate=()=>{questionsScore.innerText=scores},setUserInfo=()=>{userData&&verifyAuth()},setQuestion=a=>{if(a&&(questionsArr=a),questionsArr)switch(catchAnswer=!1,questionsQuantityUpdate(),questionsScoreUpdate(),question=questionsArr[questionNum-1],trueAnswer="checklist"===question.view?question.trueAnswer:question.trueAnswer.join(),questionBlock.classList=`questions_page${question.category} questions`,headerBlock.classList=`header-wrapper header-logo-bg${question.category}`,goals.src=`../img/questions/GOALS_Ukr${question.category}.png`,bg.style.backgroundImage=`url(../img/bg/bg_${question.category}.jpg)`,questionText.innerText=`${question.question}`,question.view){case"range":setRange(question.answers);break;case"checklist":setList(question.answers);break;case"countriesCheckList":setList(question.answers);break;default:setButtons(question.answers);}},setButtons=a=>{const b=[];let c;c=2<a.length?create("div","navi-buttons",null,answersBlock):create("div","three-buttons",null,answersBlock),a.forEach((c,d)=>{let e;e=2<a.length?create("button",`item${d}`,c):create("button",`i${d+1} item${d+1}`,c),e.addEventListener("click",a=>verifyAnswer(a.target),{once:!0}),c===trueAnswer&&(trueAnswerBlock=e),b.push(e)});const d=2<a.length?"item3":"i3 item3 skip-answer",e=create("button",d,"\u041F\u0440\u043E\u043F\u0443\u0441\u0442\u0438\u0442\u0438 \u043F\u0438\u0442\u0430\u043D\u043D\u044F",null,["type","button"],["id","skip"]);e.addEventListener("click",a=>verifyAnswer(a.target),{once:!0}),b.push(e);let f,g;2<a.length?(f=create("div","item-block1",b.slice(0,2),c),g=create("div","item-block2",b.slice(2),c)):f=create("div","item-block1",b,c,["id","buttons3"])},setRange=a=>{const b=trueAnswer.split("-"),c=b[0],d=b[1],e=a[0],f=a[1],g=a[2];let h="";const i=create("p","myRange","",null,["id","gen"]),j=create("div","navi-buttons",null,answersBlock,["id","rangeBlock"]),k=create("input","myRange","",null,["type","range"],["id","numRight"],["min",e],["max",f]),l=create("button","myRange","\u0414\u0430\u0442\u0438 \u0432\u0456\u0434\u043F\u043E\u0432\u0456\u0434\u044C",null,["type","button"],["id","enter"]),m=create("button","myRange","\u041F\u0440\u043E\u043F\u0443\u0441\u0442\u0438\u0442\u0438 \u043F\u0438\u0442\u0430\u043D\u043D\u044F",null,["type","button"],["id","skip"]),n=create("div","range-block1",[k,i],j),o=create("div","range-block2",[l,m],j);k.addEventListener("change",a=>{h=a.target.value,i.innerText=h}),l.addEventListener("click",()=>p(i),{once:!0}),m.addEventListener("click",()=>p("wrong"),{once:!0});const p=a=>{if(catchAnswer)return;catchAnswer=!0;let b="",e=document.getElementById("enter");""===i.innerHTML&&"wrong"!==a?(showModalEmptyAnswer(),catchAnswer=!1,l.addEventListener("click",()=>p(i),{once:!0}),m.addEventListener("click",()=>p("wrong"),{once:!0})):(k.valueAsNumber>=c&&k.valueAsNumber<=d?(e.style.backgroundColor=trueColor,setTimeout(()=>answerIsTrue(),1e3)):(e.style.backgroundColor=wrongColor,setTimeout(()=>answerIsWrong(),2e3)),b=trueAnswer+g+" (\u0432\u0456\u0434 "+c+" \u0434\u043E "+d+")",e.innerHTML=b)}},setList=a=>{function b(){let a=document.getElementById("dropup");a.classList.remove("hover"),a.classList.toggle("showList")}const c=create("button","i2 item2","\u0414\u0430\u0442\u0438 \u0432\u0456\u0434\u043F\u043E\u0432\u0456\u0434\u044C",null,["type","submit"],["form","listup"],["id","enter"]),d=create("button","i3 item3","\u041F\u0440\u043E\u043F\u0443\u0441\u0442\u0438\u0442\u0438 \u043F\u0438\u0442\u0430\u043D\u043D\u044F",null,["type","button"],["id","skip"]);d.addEventListener("click",()=>{setTimeout(()=>answerIsWrong(),1e3),c.style.backgroundColor=wrongColor});const e=[];a.forEach((a,b)=>{const c="s"+b,d=create("label","selectLabel",a,null,["for",c]),f=create("input","selectInput",a,null,["id",c],["type","checkbox"],["value",a],["name","selectAnsw"]),g=create("div","selectDiv",[d,f],null);e.push(g)});const f=create("button","list-item1","\u041E\u0431\u0435\u0440\u0456\u0442\u044C \u0432\u0430\u0440\u0456\u0430\u043D\u0442\u0438",null,["type","button"],["id","btnList","onclick","listshow()"]),g=create("div","arrow",null,null);f.addEventListener("click",b),g.addEventListener("click",b);const h=create("div","selectDivCommon",e,null),i=create("div","scrollSelect hover",h,null,["id","dropup"]),j=create("form","listup",[f,i,g],null,["id","listup"]),k=create("div","list-block",[j],null),l=create("div","item-block1",[k,c,d],null,["id","list"]),m=create("div","three-buttons navi-list",[l],answersBlock);j.addEventListener("submit",function(a){a.preventDefault();const b=Array.from(a.target);let c=[];b.forEach(a=>{a.checked&&c.push(a.value)}),1>c.length?showModalEmptyAnswer():n(c)});const n=a=>{let b=0;a.forEach(a=>{-1!==trueAnswer.indexOf(a)&&b++}),b>=a.length?(answerIsTrue(),c.style.backgroundColor=trueColor):(answerIsWrong(),c.style.backgroundColor=wrongColor)}};handler();